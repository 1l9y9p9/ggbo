image: archlinux
packages:
  - crowdin-cli-bin
  - fmm
sources:
  - 'git@git.sr.ht:~raiguard/Krastorio2'
secrets:
  - 6c693801-2009-4531-98ea-eb0863140971
  - fc39ea3f-59de-4230-9eec-9835e6006322
tasks:
  - crowdin: |
      set +x
      export CROWDIN_PERSONAL_TOKEN=$(cat ~/.crowdin-token)
      set -x

      cd Krastorio2

      # Quote sources
      for file in $(find ./locale -name "*.cfg"); do
          perl -pi -e 's/\"/\\\"/g' $file
          perl -pi -e 's/([^=])=(.*)/\1="\2"/' $file
      done

      crowdin push sources --config=.crowdin.yml
      crowdin pull --config=.crowdin.yml

      # Unquote translations
      for file in $(find ./locale -name "*.cfg"); do
          perl -pi -e 's/([^=])="(.*)"/\1=\2/' $file
          perl -pi -e 's/\\\"/\"/g' $file
      done

      git add .
      git commit -m "Update Crowdin translations"
  - package: |
      # Extract version for later use
      grep 'Version:' changelog.txt | awk '{print $2}' | head -1 > ../version
      version=$(cat ../version)

      cd Krastorio2

      # Datestamp changelog and commit
      sed -i "3s/.*/Date: $(date -I)/" changelog.txt
      git add changelog.txt
      git commit -m "Prepare to release version $version"

      # Create tag with changelog
      changelog=$(awk "/Version: $version$/ { flag = 1 } /^--/ { flag = 0 } flag { gsub(/^  /, \"\"); print }" $file | tail -n +3)
      git tag v$version -a -m "$changelog"

      # Create archive
      git archive --format=zip --prefix=Krastorio2/ HEAD -o ../Krastorio2_$version.zip
  - publish: |
      set +x
      token=$(cat .factorio-token)
      set -x

      fmm publish Krastorio2_$(cat version).zip --token $token
  - increment: |
      # Increment version
      version=$(cat version | awk 'BEGIN { FS = "."; OFS = "." } { print $1, $2, $3 + 1 }')
      cd Krastorio2
      sed -i "s/^  \"version\":.*\$/  \"version\": \"$version\",/" info.json
      echo -e "---------------------------------------------------------------------------------------------------\nVersion: $version\nDate: ????\n  Features:\n$(cat changelog.txt)" > changelog.txt

      git add .
      git commit -m "Move to version $version"
  - push: |
      cat <<EOF >>~/.ssh/known_hosts
      git.sr.ht ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZ+l/lvYmaeOAPeijHL8d4794Am0MOvmXPyvHTtrqvgmvCJB8pen/qkQX2S1fgl9VkMGSNxbp7NF7HmKgs5ajTGV9mB5A5zq+161lcp5+f1qmn3Dp1MWKp/AzejWXKW+dwPBd3kkudDBA1fa3uK6g1gK5nLw3qcuv/V4emX9zv3P2ZNlq9XRvBxGY2KzaCyCXVkL48RVTTJJnYbVdRuq8/jQkDRA8lHvGvKI+jqnljmZi2aIrK9OGT2gkCtfyTw2GvNDV6aZ0bEza7nDLU/I+xmByAOO79R1Uk4EYCvSc1WXDZqhiuO2sZRmVxa0pQSBDn1DB3rpvqPYW+UvKB3SOz
      git.sr.ht ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCj6y+cJlqK3BHZRLZuM+KP2zGPrh4H66DacfliU1E2DHAd1GGwF4g1jwu3L8gOZUTIvUptqWTkmglpYhFp4Iy4=
      git.sr.ht ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMZvRd4EtM7R+IHVMWmDkVU3VLQTSwQDSAvW0t2Tkj60
      EOF

      git push
      git push --tags
